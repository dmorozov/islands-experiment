# Data Model: Task Manager Application

**Date**: 2025-11-21
**Status**: Complete
**Related**: [plan.md](./plan.md), [research.md](./research.md)

## Overview

This document defines all data entities for the Task Manager application, including JPA entities (server-side) and TypeScript interfaces (client-side).

---

## Server-Side Entities (JPA / H2 Database)

### 1. Task Entity

**Purpose**: Represents a user's task/todo item

**Java Implementation**:
```java
package org.acme.taskmanager.model;

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import java.time.LocalDateTime;
import java.util.UUID;

@Entity
@Table(name = "tasks", indexes = {
    @Index(name = "idx_task_user", columnList = "user_id"),
    @Index(name = "idx_task_category", columnList = "category_id"),
    @Index(name = "idx_task_completed", columnList = "completed"),
    @Index(name = "idx_task_created", columnList = "created_at")
})
public class Task {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @NotNull
    @Size(min = 1, max = 200)
    @Column(nullable = false, length = 200)
    private String title;

    @Size(max = 2000)
    @Column(length = 2000)
    private String description;

    @NotNull
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "category_id", nullable = false)
    private Category category;

    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 10)
    private Priority priority = Priority.MEDIUM;

    @Column(nullable = false)
    private boolean completed = false;

    @Column(name = "completed_at")
    private LocalDateTime completedAt;

    @NotNull
    @Column(name = "user_id", nullable = false, length = 100)
    private String userId;  // From session

    @CreationTimestamp
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @UpdateTimestamp
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    // Getters, setters, equals, hashCode
}

public enum Priority {
    HIGH, MEDIUM, LOW
}
```

**TypeScript Interface** (generated by Orval):
```typescript
export interface Task {
  id: string;
  title: string;
  description?: string;
  categoryId: string;
  priority: 'HIGH' | 'MEDIUM' | 'LOW';
  completed: boolean;
  completedAt?: string;  // ISO 8601
  userId: string;
  createdAt: string;  // ISO 8601
  updatedAt: string;  // ISO 8601
}
```

**Validation Rules**:
- `title`: Required, 1-200 characters
- `description`: Optional, max 2000 characters
- `priority`: Required, must be HIGH/MEDIUM/LOW
- `userId`: Required, from session context
- `categoryId`: Required, must reference valid Category
- `completedAt`: Nullable, set only when `completed = true`

---

### 2. Category Entity

**Purpose**: Represents a task organization category

**Java Implementation**:
```java
package org.acme.taskmanager.model;

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.hibernate.annotations.CreationTimestamp;
import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;

@Entity
@Table(name = "categories",
       uniqueConstraints = @UniqueConstraint(columnNames = {"user_id", "name"}),
       indexes = {
           @Index(name = "idx_category_user", columnList = "user_id"),
           @Index(name = "idx_category_name", columnList = "name")
       })
public class Category {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @NotNull
    @Size(min = 1, max = 50)
    @Column(nullable = false, length = 50)
    private String name;

    @Size(max = 7)
    @Column(name = "color_code", length = 7)
    private String colorCode;  // Hex color, e.g., "#FF5733"

    @Column(name = "is_default", nullable = false)
    private boolean isDefault = false;

    @NotNull
    @Column(name = "user_id", nullable = false, length = 100)
    private String userId;  // From session

    @CreationTimestamp
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @OneToMany(mappedBy = "category", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Task> tasks;

    // Getters, setters, equals, hashCode

    // Business logic
    public boolean canDelete() {
        return !isDefault;
    }
}
```

**TypeScript Interface** (generated by Orval):
```typescript
export interface Category {
  id: string;
  name: string;
  colorCode?: string;
  isDefault: boolean;
  userId: string;
  createdAt: string;  // ISO 8601
  taskCount?: number;  // Computed field from DTO
}
```

**Validation Rules**:
- `name`: Required, 1-50 characters, unique per user
- `colorCode`: Optional, valid hex color format (#RRGGBB)
- `isDefault`: Required, cannot delete if true
- `userId`: Required, from session context

**Default Categories** (seeded on user first login):
- Work (#3B82F6 - blue)
- Personal (#10B981 - green)
- Shopping (#F59E0B - amber)

---

## Client-Side Models (TypeScript / Browser Storage)

### 3. UserPreferences Model

**Purpose**: Client-side user preferences stored in localStorage

**TypeScript Interface**:
```typescript
// src/types/preferences.ts
export interface UserPreferences {
  theme: 'light' | 'dark';
  lastViewedPage: string;
  activeFilters: {
    category?: string;
    priority?: 'HIGH' | 'MEDIUM' | 'LOW';
    status?: 'active' | 'completed';
  };
  tasksPerPage: number;
}

export const defaultPreferences: UserPreferences = {
  theme: 'light',
  lastViewedPage: '/',
  activeFilters: {},
  tasksPerPage: 20,
};
```

**Storage Implementation**:
```typescript
// src/lib/storage.ts
import type { UserPreferences } from '@/types/preferences';
import { defaultPreferences } from '@/types/preferences';

const STORAGE_KEY = 'taskmanager:prefs';

export const preferences = {
  get(userId: string): UserPreferences {
    try {
      const key = `${STORAGE_KEY}:${userId}`;
      const stored = localStorage.getItem(key);
      if (!stored) return { ...defaultPreferences };
      return { ...defaultPreferences, ...JSON.parse(stored) };
    } catch (error) {
      console.error('Failed to load preferences:', error);
      return { ...defaultPreferences };
    }
  },

  set(userId: string, prefs: Partial<UserPreferences>): void {
    try {
      const key = `${STORAGE_KEY}:${userId}`;
      const current = this.get(userId);
      const updated = { ...current, ...prefs };
      localStorage.setItem(key, JSON.stringify(updated));
    } catch (error) {
      console.error('Failed to save preferences:', error);
    }
  },

  clear(userId: string): void {
    const key = `${STORAGE_KEY}:${userId}`;
    localStorage.removeItem(key);
  },
};
```

**Validation**:
- Zod schema for runtime validation (optional but recommended)

```typescript
import { z } from 'zod';

export const UserPreferencesSchema = z.object({
  theme: z.enum(['light', 'dark']),
  lastViewedPage: z.string(),
  activeFilters: z.object({
    category: z.string().optional(),
    priority: z.enum(['HIGH', 'MEDIUM', 'LOW']).optional(),
    status: z.enum(['active', 'completed']).optional(),
  }),
  tasksPerPage: z.number().int().min(5).max(100),
});
```

---

### 4. PerformanceMetrics Model

**Purpose**: Client-side performance metrics for demonstration

**TypeScript Interface**:
```typescript
// src/types/performance.ts
export interface IslandHydration {
  islandName: string;
  durationMs: number;
}

export interface PerformanceMetrics {
  pageName: string;
  bundleSize: number;  // KB
  islandHydrations: IslandHydration[];
  timeToInteractive: number;  // ms
  firstContentfulPaint: number;  // ms
  largestContentfulPaint: number;  // ms
  timestamp: string;  // ISO 8601
}
```

**Collection Implementation**:
```typescript
// src/lib/performance.ts
import type { PerformanceMetrics } from '@/types/performance';

export function collectMetrics(pageName: string): PerformanceMetrics {
  const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
  const paintEntries = performance.getEntriesByType('paint');

  const fcp = paintEntries.find(e => e.name === 'first-contentful-paint')?.startTime || 0;
  const lcp = 0;  // Requires PerformanceObserver for LCP

  // Collect custom island hydration marks
  const islandHydrations = performance
    .getEntriesByType('measure')
    .filter(e => e.name.endsWith('-hydration'))
    .map(e => ({
      islandName: e.name.replace('-hydration', ''),
      durationMs: e.duration,
    }));

  return {
    pageName,
    bundleSize: 0,  // Requires build-time calculation
    islandHydrations,
    timeToInteractive: navigation.domInteractive - navigation.fetchStart,
    firstContentfulPaint: fcp,
    largestContentfulPaint: lcp,
    timestamp: new Date().toISOString(),
  };
}
```

---

## DTOs (Data Transfer Objects)

DTOs are used for API requests/responses. Orval will generate TypeScript types from these.

### Task DTOs

```java
package org.acme.taskmanager.dto;

public record TaskCreateDTO(
    @NotNull @Size(min = 1, max = 200) String title,
    @Size(max = 2000) String description,
    @NotNull UUID categoryId,
    @NotNull Priority priority
) {}

public record TaskUpdateDTO(
    @Size(min = 1, max = 200) String title,
    @Size(max = 2000) String description,
    UUID categoryId,
    Priority priority
) {}

public record TaskResponseDTO(
    UUID id,
    String title,
    String description,
    CategoryResponseDTO category,
    Priority priority,
    boolean completed,
    LocalDateTime completedAt,
    LocalDateTime createdAt,
    LocalDateTime updatedAt
) {
    public static TaskResponseDTO from(Task task) {
        return new TaskResponseDTO(
            task.getId(),
            task.getTitle(),
            task.getDescription(),
            CategoryResponseDTO.from(task.getCategory()),
            task.getPriority(),
            task.isCompleted(),
            task.getCompletedAt(),
            task.getCreatedAt(),
            task.getUpdatedAt()
        );
    }
}
```

### Category DTOs

```java
package org.acme.taskmanager.dto;

public record CategoryCreateDTO(
    @NotNull @Size(min = 1, max = 50) String name,
    @Size(max = 7) String colorCode
) {}

public record CategoryUpdateDTO(
    @Size(min = 1, max = 50) String name,
    @Size(max = 7) String colorCode
) {}

public record CategoryResponseDTO(
    UUID id,
    String name,
    String colorCode,
    boolean isDefault,
    LocalDateTime createdAt,
    Long taskCount  // Computed
) {
    public static CategoryResponseDTO from(Category category) {
        return new CategoryResponseDTO(
            category.getId(),
            category.getName(),
            category.getColorCode(),
            category.isDefault(),
            category.getCreatedAt(),
            (long) category.getTasks().size()
        );
    }
}
```

### Statistics DTOs

```java
package org.acme.taskmanager.dto;

public record CompletionStatsDTO(
    long todayCount,
    long weekCount,
    long totalCount,
    double completionRate  // Percentage
) {}

public record CompletionHistoryDTO(
    LocalDate date,
    long count
) {}
```

---

## Entity Relationships

```
User (Session)
  │
  ├─── hasMany ──→ Task
  │                  ├── belongsTo ──→ Category
  │                  └── priority: Priority enum
  │
  └─── hasMany ──→ Category
                     ├── isDefault: boolean
                     └── hasMany ──→ Task
```

---

## Database Indexes

**Performance Optimization**:

1. **tasks table**:
   - `idx_task_user` on `user_id` - Filter tasks by user
   - `idx_task_category` on `category_id` - Filter tasks by category
   - `idx_task_completed` on `completed` - Filter active/completed
   - `idx_task_created` on `created_at` - Sort by creation date

2. **categories table**:
   - `idx_category_user` on `user_id` - Filter categories by user
   - `idx_category_name` on `name` - Sort alphabetically
   - Unique constraint on `(user_id, name)` - Prevent duplicates

---

## Migration Strategy

**Initial Database Setup** (H2 in-memory):

```sql
-- Automatically created by Hibernate/Quarkus
-- Schema DDL generation from JPA annotations
-- Default data seeded via @PostConstruct in CategoryService
```

**Seed Default Categories**:
```java
@ApplicationScoped
public class CategoryService {

    @Transactional
    public void ensureDefaultCategories(String userId) {
        if (categoryRepository.countByUserId(userId) == 0) {
            categoryRepository.persist(new Category("Work", "#3B82F6", true, userId));
            categoryRepository.persist(new Category("Personal", "#10B981", true, userId));
            categoryRepository.persist(new Category("Shopping", "#F59E0B", true, userId));
        }
    }
}
```

---

## Type Safety

**Orval Code Generation** ensures type safety:

```typescript
// Auto-generated by Orval from OpenAPI schema
import { useQuery, useMutation } from '@tanstack/react-query';

// Type-safe hooks
export const useGetTasks = (params: GetTasksParams) => {
  return useQuery<Task[], Error>({
    queryKey: ['tasks', params],
    queryFn: () => api.getTasks(params),
  });
};

export const useCreateTask = () => {
  return useMutation<Task, Error, TaskCreateDTO>({
    mutationFn: (data) => api.createTask(data),
  });
};
```

**Usage in Components**:
```typescript
import { useGetTasks, useCreateTask } from '@/lib/api';

export function TaskList() {
  const { data: tasks, isLoading } = useGetTasks({ status: 'active' });
  const createTask = useCreateTask();

  // TypeScript knows exact shape of tasks and createTask
}
```

---

## Summary

- **2 JPA Entities**: Task, Category
- **2 Client Models**: UserPreferences, PerformanceMetrics
- **8 DTOs**: Create/Update/Response for Task and Category, Stats DTOs
- **Full Type Safety**: Java validation + TypeScript types via Orval
- **Performance**: Optimized indexes for common queries
- **Validation**: Bean Validation on server, Zod on client

**Next**: See [contracts/api.yaml](./contracts/api.yaml) for REST endpoint specifications
